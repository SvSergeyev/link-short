<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8"/>
    <title>Сервис сокращения ссылок</title>
    <link rel="stylesheet" th:href="@{/css/style.css}"/>
</head>
<body>

<h1>Сервис сокращения ссылок</h1>

<form id="shortenForm" onsubmit="return false;">
    <input type="text" id="urlInput" name="url" placeholder="Вставьте ссылку сюда" required autofocus />
    <button type="submit" id="shortenButton">Сократить</button>

    <input type="text" id="resultInput" disabled placeholder="Результат появится здесь" />
    <button type="button" id="copyButton" disabled>Скопировать</button>
</form>

<script>
    const shortenForm = document.getElementById('shortenForm');
    const urlInput = document.getElementById('urlInput');
    const resultInput = document.getElementById('resultInput');
    const shortenButton = document.getElementById('shortenButton');
    const copyButton = document.getElementById('copyButton');

    shortenForm.addEventListener('submit', () => {
        const url = urlInput.value.trim();
        if (url.length === 0) {
            alert('Пожалуйста, вставьте ссылку.');
            return;
        }

        if (url.length >= 3000) {
            alert('Не более 3000 символов');
            return;
        }

        shortenButton.disabled = true;
        copyButton.classList.remove('copied');
        copyButton.textContent = 'Скопировать';
        copyButton.disabled = true;
        resultInput.value = '';
        resultInput.disabled = true;

        fetch('/projects/link-shortener/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({url: url})
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка сети');
                }
                return response.text();
            })
            .then(shortenedUrl => {
                resultInput.value = shortenedUrl;
                resultInput.disabled = false;
                copyButton.disabled = false;
            })
            .catch(error => {
                alert('Ошибка при сокращении ссылки: ' + error.message);
            })
            .finally(() => {
                shortenButton.disabled = false;
            });
    });

    copyButton.addEventListener('click', () => {
        if (!resultInput.disabled && resultInput.value.trim() !== '') {
            resultInput.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    copyButton.classList.add('copied');
                    copyButton.textContent = 'Скопировано';
                } else {
                    alert('Не удалось скопировать текст');
                }
            } catch (err) {
                alert('Ошибка копирования: ' + err);
            }
            window.getSelection().removeAllRanges(); // Снять выделение
        }
    });

</script>

<footer>
    <p>Ссылки действительны <span th:text="${expirationDays}">x</span> дней</p>
</footer>
</body>
</html>
